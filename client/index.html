<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <script>
      // WALLET COMPATIBILITY FIX - Must run before anything else
      (function() {
        console.log('Applying wallet browser compatibility fixes');
        
        // Check if we're in a wallet browser
        const isWalletBrowser = navigator.userAgent.includes('Phantom') || 
                              navigator.userAgent.includes('Solflare') ||
                              document.referrer.includes('phantom') ||
                              document.referrer.includes('solflare');
        
        // Store this for later detection
        window.__isWalletBrowser = isWalletBrowser;
        
        // Fix for Solflare's startsWith error
        try {
          // Save original method
          const originalStartsWith = String.prototype.startsWith;
          
          // Override with safe version
          String.prototype.startsWith = function(searchString, position) {
            try {
              if (!this || this === null || this === undefined) return false;
              if (!searchString) return false;
              return originalStartsWith.call(this, searchString, position);
            } catch (e) {
              console.warn('Prevented startsWith error');
              return false;
            }
          };
          
          console.log('Applied String.prototype.startsWith fix');
        } catch (e) {
          console.error('Failed to apply startsWith fix', e);
        }
        
        // Preserve referral code across pages/frames
        try {
          // Check URL for referral code
          const urlParams = new URLSearchParams(window.location.search);
          const refCode = urlParams.get('ref');
          
          if (refCode) {
            // Store in every possible storage mechanism
            try { localStorage.setItem('walletReferralCode', refCode); } catch (e) {}
            try { localStorage.setItem('referralCode', refCode); } catch (e) {}
            try { sessionStorage.setItem('walletReferralCode', refCode); } catch (e) {}
            try { sessionStorage.setItem('referralCode', refCode); } catch (e) {}
            
            // Also set as cookie with long expiration
            const d = new Date();
            d.setTime(d.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 year
            document.cookie = `referralCode=${refCode};expires=${d.toUTCString()};path=/;SameSite=Lax`;
            
            console.log('Stored referral code in all storage mechanisms:', refCode);
          } else {
            // Try to restore from storage
            const storedCode = localStorage.getItem('walletReferralCode') || 
                              localStorage.getItem('referralCode') || 
                              sessionStorage.getItem('walletReferralCode') || 
                              sessionStorage.getItem('referralCode');
            
            // Also try to get from cookie
            const getCookie = (name) => {
              const value = `; ${document.cookie}`;
              const parts = value.split(`; ${name}=`);
              if (parts.length === 2) return parts.pop().split(';').shift();
            };
            const cookieCode = getCookie('referralCode');
            
            const finalCode = storedCode || cookieCode;
            
            if (finalCode) {
              // If found in storage but not in URL, add to URL
              const url = new URL(window.location.href);
              url.searchParams.set('ref', finalCode);
              
              // Replace the URL without reloading the page
              try {
                window.history.replaceState({}, '', url.toString());
                console.log('Restored referral code to URL:', finalCode);
              } catch (e) {
                console.warn('Failed to update URL with referral code', e);
              }
            }
          }
        } catch (e) {
          console.error('Error handling referral code', e);
        }
        
        // Error prevention for wallet-related issues
        window.addEventListener('error', function(event) {
          if (event && event.message && 
              (event.message.includes('startsWith') || 
               event.message.includes('solflare') || 
               event.message.includes('wallet'))) {
            console.warn('Suppressed wallet-related error:', event.message);
            event.preventDefault();
            event.stopPropagation();
            return true;
          }
        }, true);
        
        window.addEventListener('unhandledrejection', function(event) {
          if (event && event.reason && 
              (String(event.reason).includes('startsWith') || 
               String(event.reason).includes('solflare') || 
               String(event.reason).includes('wallet'))) {
            console.warn('Suppressed wallet-related promise rejection:', event.reason);
            event.preventDefault();
            event.stopPropagation();
            return true;
          }
        }, true);
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <!-- This script injects a replit badge into the page, please feel free to remove this line -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-badge-v3.js"></script>
  </body>
</html>